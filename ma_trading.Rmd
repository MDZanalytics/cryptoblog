---
title: "Does volatility decrease with increasing market cap?"
author: "Mark Ziemann"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
theme: cosmo
---

## Intro

Trading off moving averages, exponenial moving averages and crosses between these is a popular method for timing entry and exit of positions.
In this blog post I will be trilaing simple moving averages to find the one which performs the best.

```{r,lib}

library("jsonlite")
library("tidyverse")
library("runner")
library("quantmod")
library("TTR")

```

## Get data

We will be simplifying things by working only with the market cap of the top two stablecoins Tether (USDT) and USD Coin (USDC) against cryptocurrencies Bitcoin (BTC) and Ethereum (ETH).

```{r,getdata}

download.file("https://web-api.coinmarketcap.com/v1/cryptocurrency/ohlcv/historical?symbol=BTC&convert=USD&interval=daily&time_start=2013-06-01&time_end=2021-02-19",destfile="btcdat.txt")

btcdat <- fromJSON("btcdat.txt")

price <- btcdat$data$quotes

price <- data.frame(price$time_close,price$quote$USD$close)

colnames(price) <- c("date","Close")

price$date <- sapply(strsplit(price$date,"T"),"[[",1)

```

## Calculate hodl returns

```{r,hodl}

myend <- price[c(1,nrow(price)),2][2] 

mystart <- price[c(1,nrow(price)),2][1] 

hodl <- (myend - mystart) / mystart

hodl


```


## Moving average function

```{r,sma}

sma <- function(price,n) { 

ma <- SMA(Cl(price),n=n)

price2 <- price

price2$ma <- ma

price2$higher <- price2$Close > price2$ma

yesterday <- price2$higher

yesterday <- c(NA,yesterday)

yesterday <- yesterday[1:(length(yesterday)-1)]

price2$yesterday <- yesterday

price2$trade <- apply(price2,1,function(x) {
  as.numeric(as.logical(x[4])) - as.numeric(as.logical(x[5]))
} )

price2 <- price2[which(price2$trade!=0),]

if ( price2$trade[1] == -1 ) { price2 <- price2[2:nrow(price2),] }

if ( tail(price2,1)$trade ) { price2 <- price2[1:(nrow(price2)-1),] }

buy <- subset(price2,trade==1)[,c(1,2)]  

colnames(buy) <- c("buy_date","buy_price")

sell <- subset(price2,trade==-1)[,c(1,2)]

colnames(sell) <- c("sell_date","sell_price")

trades <- cbind(buy,sell)

trades$diff <- ( ( trades$sell_price - trades$buy_price ) / trades$buy_price ) +1 - 0.0025

return(prod(trades$diff))

}


```

## Exponential moving average function


```{r,ema}

ema <- function(price,n) {

ma <- EMA(Cl(price),n=n)

price2 <- price

price2$ma <- ma

price2$higher <- price2$Close > price2$ma

yesterday <- price2$higher

yesterday <- c(NA,yesterday)

yesterday <- yesterday[1:(length(yesterday)-1)]

price2$yesterday <- yesterday

price2$trade <- apply(price2,1,function(x) {
  as.numeric(as.logical(x[4])) - as.numeric(as.logical(x[5]))
} )

price2 <- price2[which(price2$trade!=0),]

if ( price2$trade[1] == -1 ) { price2 <- price2[2:nrow(price2),] }

if ( tail(price2,1)$trade ) { price2 <- price2[1:(nrow(price2)-1),] }

buy <- subset(price2,trade==1)[,c(1,2)]

colnames(buy) <- c("buy_date","buy_price")

sell <- subset(price2,trade==-1)[,c(1,2)]

colnames(sell) <- c("sell_date","sell_price")

trades <- cbind(buy,sell)

trades$diff <- ( ( trades$sell_price - trades$buy_price ) / trades$buy_price ) +1 - 0.0025

return(prod(trades$diff))

}

```


```{r,backtest}

res_sma <- c(0,0,sapply(3:200,function(n) { sma(price,n) } ) )

res_ema <- c(0,0,sapply(3:200,function(n) { ema(price,n) } ) )

```

## Plots

```{r,plots,fig.height=8,fig.width=8}

plot(res_sma,pch=19,xlab="moving average interval (days)",ylab="fold return",main="SMA")
abline(h=hodl,col="red")
grid()

plot(res_sma,pch=19,xlim=c(1,50),xlab="moving average interval (days)",ylab="fold return",main="SMA")
abline(h=hodl,col="red")
grid()

plot(res_ema,pch=19,xlab="moving average interval (days)",ylab="fold return",main="EMA")
abline(h=hodl,col="red")
grid()

plot(res_ema,pch=19,xlim=c(1,50),xlab="moving average interval (days)",ylab="fold return",main="EMA")
abline(h=hodl,col="red")
grid()

```

## Optimisation

```{r,best_sma,fig.width=10,fig.height=8}

best_sma = which(res_sma==max(res_sma))

best_sma

ma <- SMA(Cl(price),n=best_sma)

price2 <- price

price2$ma <- ma

price2$higher <- price2$Close > price2$ma

yesterday <- price2$higher

yesterday <- c(NA,yesterday)

yesterday <- yesterday[1:(length(yesterday)-1)]

price2$yesterday <- yesterday

price2$trade <- apply(price2,1,function(x) {
  as.numeric(as.logical(x[4])) - as.numeric(as.logical(x[5]))
} )

price2 <- price2[which(price2$trade!=0),]

if ( price2$trade[1] == -1 ) { price2 <- price2[2:nrow(price2),] }

if ( tail(price2,1)$trade ) { price2 <- price2[1:(nrow(price2)-1),] }

buy <- subset(price2,trade==1)[,c(1,2)]  

colnames(buy) <- c("buy_date","buy_price")

sell <- subset(price2,trade==-1)[,c(1,2)]

colnames(sell) <- c("sell_date","sell_price")

trades <- cbind(buy,sell)

trades$diff <- ( ( trades$sell_price - trades$buy_price ) / trades$buy_price ) +1 - 0.0025

trades 

prod(trades$diff)

HEADER=paste(best_sma,"day moving average")

plot(price$Close~as.Date(price$date),type="l",log="y",
  xlab="Date",ylab="price (USD)",main=HEADER)
grid()
lines(ma~ as.Date(price$date) ,col="red")

```

```{r,best_ema,fig.width=10,fig.height=8}

best_ema = which(res_ema==max(res_ema))

best_ema

ma <- EMA(Cl(price),n=best_ema)

price2 <- price

price2$ma <- ma

price2$higher <- price2$Close > price2$ma

yesterday <- price2$higher

yesterday <- c(NA,yesterday)

yesterday <- yesterday[1:(length(yesterday)-1)]

price2$yesterday <- yesterday

price2$trade <- apply(price2,1,function(x) {
  as.numeric(as.logical(x[4])) - as.numeric(as.logical(x[5]))
} )

price2 <- price2[which(price2$trade!=0),]

if ( price2$trade[1] == -1 ) { price2 <- price2[2:nrow(price2),] }

if ( tail(price2,1)$trade ) { price2 <- price2[1:(nrow(price2)-1),] }

buy <- subset(price2,trade==1)[,c(1,2)]

colnames(buy) <- c("buy_date","buy_price")

sell <- subset(price2,trade==-1)[,c(1,2)]

colnames(sell) <- c("sell_date","sell_price")

trades <- cbind(buy,sell)

trades$diff <- ( ( trades$sell_price - trades$buy_price ) / trades$buy_price ) +1 - 0.0025

trades

prod(trades$diff)

HEADER=paste(best_ema,"day exponential moving average")

plot(price$Close~as.Date(price$date),type="l",log="y",
  xlab="Date",ylab="price (USD)",main=HEADER)
grid()
lines(ma~ as.Date(price$date) ,col="red")


```

## Conclusion

Holing BTC over this period have a 456 fold return.
The best simple moving average was 23 days, which gave a 1132.7 fold return.
The best exponential moving average was 14 days, which gave a return of 1229 fold.

## Session information

For reproducibility

```{r,sessioninfo}

sessionInfo()

```
