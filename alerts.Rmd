---
title: "Daily alerts for BTC and ETH"
author: "Mark Ziemann https://mdz-analytics.com"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
theme: cosmo
---

## Intro

Previously I showed that the 43 day moving average was amongst the simplest and most profitable trading signals for Bitcoin.
For ETH, the 34 day is preferred.
This is a script designed to send a trade alert for buy and sell signals.

```{r,lib}

library("jsonlite")
library("tidyverse")
library("runner")
library("quantmod")
library("TTR")
library("RPushbullet")

TESTING = FALSE

```

## Get current price data

```{r,getcurrent1}

URL="https://web-api.coinmarketcap.com/v1/cryptocurrency/listings/latest?limit=200"
download.file(URL,destfile="cmcdat.txt")
cmcdat <- fromJSON("cmcdat.txt")
cmcdf <- data.frame(cmcdat$data[,1:4],cmcdat$data$quote$USD)
dim(cmcdf)

```

## Get BTC data

Obtaining BTC historical data (daily).

```{r,btc1}

datebefore <- Sys.Date()-100
mydate <- Sys.Date()-1
URL=paste("https://web-api.coinmarketcap.com/v1/cryptocurrency/ohlcv/historical?symbol=BTC&convert=USD&interval=daily&time_start=",datebefore,"&time_end=",mydate,sep="")
download.file(URL,destfile="btcdat.txt")
btcdat <- fromJSON("btcdat.txt")
btcdat <- btcdat$data$quotes

dates <- btcdat$time_close
dates <- sapply(strsplit(as.character(dates),"T"),"[[",1)
dates <- c(dates, as.Date(tail(dates,1))+1)

Close <- c(btcdat$quote$USD$close, cmcdf[which(cmcdf$symbol=="BTC"),5])

price <- data.frame(dates,Close)

if ( TESTING == TRUE) {
  price[nrow(price),"Close"] <- price[nrow(price),"Close"] * 2
}

```

## BTC on the 43 MA

```{r, btc_sma}

price$ma <- SMA(Cl(price),n=43)
price$signal <- price$Close > price$ma
tail(price)
today_signal <- price[nrow(price),"signal"]
previous_signal <- price[(nrow(price)-1),"signal"]
if (today_signal != previous_signal ) {
  if ( (today_signal == TRUE ) & (previous_signal == FALSE ) ) {
    btc_signal="BUY"
  }
  if ( (today_signal == FALSE ) & (previous_signal == TRUE ) ) { 
    btc_signal="SELL"
  }
} else {
btc_signal <- "NONE"
}
btc_signal

plot(price$Close~as.Date(price$date),type="l",
  xlab="Date",ylab="price (USD)",main="BTC w 43D MA")
grid()
lines(price$ma~ as.Date(price$date) ,col="red")

```

Send a push notification.

```{r,btcpush}

if ( btc_signal != "NONE") {
  MYNOTE <- paste("The BTC 43D MA signal is", btc_signal, 
    ". Visit https://blinder.cc/crypto/alerts.html for the details")
  pbPost("note", "Crypto Alert", MYNOTE)
}

```

## Get ETH data

Obtaining ETH historical data (daily).

```{r,eth1}

datebefore <- Sys.Date()-100
mydate <- Sys.Date()-1
URL=paste("https://web-api.coinmarketcap.com/v1/cryptocurrency/ohlcv/historical?symbol=ETH&convert=USD&interval=daily&time_start=",datebefore,"&time_end=",mydate,sep="")
download.file(URL,destfile="ethdat.txt")
ethdat <- fromJSON("ethdat.txt")
ethdat <- ethdat$data$quotes

dates <- ethdat$time_close
dates <- sapply(strsplit(as.character(dates),"T"),"[[",1)
dates <- c(dates, as.Date(tail(dates,1))+1)

Close <- c(ethdat$quote$USD$close, cmcdf[which(cmcdf$symbol=="ETH"),5])

price <- data.frame(dates,Close)

if ( TESTING == TRUE) {
  price[nrow(price),"Close"] <- price[nrow(price),"Close"] * 2
}

```

## ETH on the 34 MA

```{r, eth_sma}

price$ma <- SMA(Cl(price),n=34)
price$signal <- price$Close > price$ma
tail(price)
today_signal <- price[nrow(price),"signal"]
previous_signal <- price[(nrow(price)-1),"signal"]
if (today_signal != previous_signal ) {
  if ( (today_signal == TRUE ) & (previous_signal == FALSE ) ) {
    eth_signal="BUY"
  }
  if ( (today_signal == FALSE ) & (previous_signal == TRUE ) ) {
    eth_signal="SELL"
  }
} else {
  eth_signal <- "NONE"
}

eth_signal

plot(price$Close~as.Date(price$date),type="l",
  xlab="Date",ylab="price (USD)",main="ETH w 34D MA")
grid()
lines(price$ma~ as.Date(price$date) ,col="red")

```

Send a push notification.

```{r,ethpush}

if ( eth_signal != "NONE") {
  MYNOTE <- paste("The ETH 34D MA signal is", eth_signal,
   ". Visit https://blinder.cc/crypto/alerts.html for the details")
  pbPost("note", "Crypto Alert", MYNOTE)
}

```


## Delay 11 mins to get the close data

Sleep for a while

```{r,sleepytime}

Sys.sleep(15*60)
#Sys.sleep(1)


```

## DMI BTC

Directional movement indicator is a highly profitable approach to identify trend changes.
DMI using a 25 day interval gives returns 4x better than the 43D SMA approach.


```{r,dmi_btc,fig.height=10,fig.width=8}

datebefore <- Sys.Date()-100
mydate <- Sys.Date()-1
URL=paste("https://web-api.coinmarketcap.com/v1/cryptocurrency/ohlcv/historical?symbol=BTC&convert=USD&interval=daily&time_start=",datebefore,"&time_end=",mydate,sep="")
download.file(URL,destfile="btcdat.txt")
btcdat <- fromJSON("btcdat.txt")
price <- btcdat$data$quotes

price <- data.frame(price$time_close, price$quote$USD$high, price$quote$USD$low, price$quote$USD$close)
colnames(price) <- c("date","high","low","close")
price$date <- sapply(strsplit(as.character(price$date),"T"),"[[",1)
dmi.adx <- ADX(price[,c("high","low","close")],n=26)
price <- cbind(price,dmi.adx)
price$signal <- dmi.adx[,1] > dmi.adx[,2]                        
tail(price)

today_signal <- price[nrow(price),"signal"]
previous_signal <- price[(nrow(price)-1),"signal"]
if (today_signal != previous_signal ) {
  if ( (today_signal == TRUE ) & (previous_signal == FALSE ) ) {
    btc_signal="DMI BUY"
  }
  if ( (today_signal == FALSE ) & (previous_signal == TRUE ) ) {
    btc_signal="DMI SELL"
  }
} else {
  btc_signal <- "NONE"
}

btc_signal
price <- as.data.frame(price)
par(mfrow=c(2,1))
plot(price$close~as.Date(price$date),type="l",
  xlab="Date",ylab="price (USD)",main="BTC USD price")
grid()
plot(price$DIp~as.Date(price$date),type="l", col="blue",
  xlab="Date",ylab="price (USD)",main="BTC 6d DMI")
grid()
lines(price$DIn ~ as.Date(price$date) ,col="red")

```

Send a push notification.

```{r,btcpush2}

if ( btc_signal != "NONE") {
  MYNOTE <- paste("BTC is flashing a ", btc_signal,
   ". Visit https://blinder.cc/crypto/alerts.html for the details")
  pbPost("note", "Crypto Alert", MYNOTE)
}

```

## DMI ETH

For ETH, the 19 day interval DMI gave a good return.

```{r,dmi_eth,fig.height=10,fig.width=8}

datebefore <- Sys.Date()-100
mydate <- Sys.Date()-1
URL=paste("https://web-api.coinmarketcap.com/v1/cryptocurrency/ohlcv/historical?symbol=ETH&convert=USD&interval=daily&time_start=",datebefore,"&time_end=",mydate,sep="")
download.file(URL,destfile="ethdat.txt")
ethdat <- fromJSON("ethdat.txt")
price <- ethdat$data$quotes

price <- data.frame(price$time_close, price$quote$USD$high, price$quote$USD$low, price$quote$USD$close)
colnames(price) <- c("date","high","low","close")
price$date <- sapply(strsplit(as.character(price$date),"T"),"[[",1)
dmi.adx <- ADX(price[,c("high","low","close")],n=19)
price <- cbind(price,dmi.adx)
price$signal <- dmi.adx[,1] > dmi.adx[,2]
tail(price)

today_signal <- price[nrow(price),"signal"]
previous_signal <- price[(nrow(price)-1),"signal"]
if (today_signal != previous_signal ) {
  if ( (today_signal == TRUE ) & (previous_signal == FALSE ) ) {
    eth_signal="DMI BUY"
  }
  if ( (today_signal == FALSE ) & (previous_signal == TRUE ) ) {
    eth_signal="DMI SELL"
  }
} else {
  eth_signal <- "NONE"
}

eth_signal
price <- as.data.frame(price)
par(mfrow=c(2,1))
plot(price$close~as.Date(price$date),type="l",
  xlab="Date",ylab="price (USD)",main="ETH USD price")
grid()
plot(price$DIp~as.Date(price$date),type="l", col="blue",
  xlab="Date",ylab="price (USD)",main="ETH 6d DMI")
grid()
lines(price$DIn ~ as.Date(price$date) ,col="red")

```

Send a push notification.

```{r,ethpush2}

if ( eth_signal != "NONE") {
  MYNOTE <- paste("ETH is flashing a ", eth_signal,
   ". Visit https://blinder.cc/crypto/alerts.html for the details")
  pbPost("note", "Crypto Alert", MYNOTE)
}

```




## Session information
For reproducibility

```{r,sessioninfo}

sessionInfo()

```
